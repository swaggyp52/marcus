<!-- V0.2 UI ADDITIONS: Inbox Drop Zone, Claims View, Calendar -->
<!-- This file contains the HTML/CSS/JS additions for v0.2 features -->
<!-- To be integrated into main index.html -->

<style>
/* Inbox Drop Zone */
.inbox-drop-zone {
    border: 3px dashed #667eea;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    background: #1a1a2e;
    margin: 20px 0;
    cursor: pointer;
    transition: all 0.3s;
}

.inbox-drop-zone.dragover {
    background: #667eea22;
    border-color: #764ba2;
}

.inbox-drop-zone:hover {
    background: #252540;
}

.inbox-item {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.confidence-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 600;
}

.confidence-high { background: #10b98144; color: #10b981; }
.confidence-medium { background: #f59e0b44; color: #f59e0b; }
.confidence-low { background: #ef444444; color: #ef4444; }

/* Claims View */
.claim-card {
    background: #1a1a1a;
    border-left: 4px solid #667eea;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}

.claim-statement {
    font-size: 1.05em;
    margin-bottom: 10px;
    color: #e0e0e0;
}

.claim-support {
    background: #252540;
    border-radius: 6px;
    padding: 10px;
    margin: 8px 0;
    font-size: 0.9em;
    color: #aaa;
}

.claim-support:hover {
    background: #2f2f5a;
    cursor: pointer;
}

.support-quote {
    font-style: italic;
    color: #888;
    margin: 5px 0;
    padding-left: 10px;
    border-left: 2px solid #667eea;
}

.verification-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.verify-btn {
    padding: 6px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s;
}

.verify-btn.correct {
    background: #10b98144;
    color: #10b981;
}

.verify-btn.incorrect {
    background: #ef444444;
    color: #ef4444;
}

.verify-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

/* Calendar Timeline */
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline-item {
    display: flex;
    gap: 20px;
    margin: 15px 0;
    position: relative;
}

.timeline-date {
    min-width: 120px;
    text-align: right;
    color: #888;
    font-weight: 600;
}

.timeline-content {
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 15px;
    flex: 1;
}

.deadline-type {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 600;
    margin-right: 8px;
}

.type-assignment { background: #667eea44; color: #667eea; }
.type-exam { background: #ef444444; color: #ef4444; }
.type-project { background: #10b98144; color: #10b981; }

/* Modal for verification suggestions */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: #1a1a2e;
    border-radius: 10px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.suggestion-item {
    background: #252540;
    border-radius: 6px;
    padding: 15px;
    margin: 10px 0;
}
</style>

<!-- Inbox Section Template -->
<section id="inbox-section" style="display: none;">
    <h2>ðŸ“¥ Inbox</h2>
    <div class="inbox-drop-zone" id="dropZone">
        <h3>Drop files here or click to upload</h3>
        <p style="color: #888; margin-top: 10px;">Marcus will auto-classify your files</p>
        <input type="file" id="fileInput" multiple style="display: none;">
    </div>

    <div id="inboxItems"></div>
</section>

<!-- Claims View Template (shown in plan detail) -->
<div id="claimsView" style="display: none;">
    <h3>ðŸ“‹ Claims & Evidence</h3>
    <div id="claimsList"></div>
</div>

<!-- Calendar Timeline Template -->
<section id="calendar-section" style="display: none;">
    <h2>ðŸ“… Calendar</h2>
    <div style="margin-bottom: 20px;">
        <button class="btn" onclick="exportCalendar()">Export .ics Calendar</button>
    </div>
    <div class="timeline" id="timelineView"></div>
</section>

<!-- Verification Modal -->
<div class="modal" id="verificationModal">
    <div class="modal-content">
        <h3>How to Verify This Claim</h3>
        <div id="verificationSuggestions"></div>
        <button class="btn" onclick="closeVerificationModal()">Close</button>
    </div>
</div>

<script>
// V0.2 JavaScript Functions

// ============ INBOX FUNCTIONALITY ============

function initInbox() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files);
        for (const file of files) {
            await uploadToInbox(file);
        }
    });

    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            await uploadToInbox(file);
        }
    });

    loadInboxItems();
}

async function uploadToInbox(file) {
    const formData = new FormData();
    formData.append('file', file);

    const response = await fetch('/api/inbox/upload', {
        method: 'POST',
        body: formData
    });

    if (response.ok) {
        loadInboxItems();
    }
}

async function loadInboxItems() {
    const response = await fetch('/api/inbox?status=pending');
    const items = await response.json();

    const container = document.getElementById('inboxItems');
    container.innerHTML = items.map(item => `
        <div class="inbox-item">
            <div>
                <strong>${item.filename}</strong>
                <div style="font-size: 0.9em; color: #888; margin-top: 5px;">
                    ${item.classification_reasoning}
                </div>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span class="confidence-badge confidence-${item.classification_confidence}">
                    ${item.classification_confidence} confidence
                </span>
                <button class="btn" onclick="classifyItem(${item.id}, ${item.suggested_assignment_id})">
                    Accept
                </button>
            </div>
        </div>
    `).join('');
}

async function classifyItem(inboxItemId, assignmentId) {
    const response = await fetch(`/api/inbox/${inboxItemId}/classify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            assignment_id: assignmentId,
            create_new_assignment: false
        })
    });

    if (response.ok) {
        loadInboxItems();
        loadAssignments(); // Refresh assignments view
    }
}

// ============ CLAIMS & VERIFICATION ============

async function loadPlanClaims(planId) {
    const response = await fetch(`/api/plans/${planId}/claims`);
    const claims = await response.json();

    const container = document.getElementById('claimsList');
    container.innerHTML = claims.map(claim => renderClaim(claim)).join('');
}

function renderClaim(claim) {
    const supports = claim.supports.map(sup => `
        <div class="claim-support" onclick="jumpToSource(${sup.artifact_id})">
            <div style="font-size: 0.85em; color: #667eea;">
                Source: Artifact #${sup.artifact_id} | Relevance: ${sup.relevance_score}/10
            </div>
            <div class="support-quote">"${sup.quote}"</div>
        </div>
    `).join('');

    return `
        <div class="claim-card">
            <div class="claim-statement">${claim.statement}</div>
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <span class="confidence-badge confidence-${claim.confidence}">
                    ${claim.confidence} confidence
                </span>
                <span class="confidence-badge" style="background: #555;">
                    ${claim.verification_status}
                </span>
            </div>

            ${supports}

            <div class="verification-buttons">
                <button class="verify-btn correct" onclick="verifyClaim(${claim.id}, 'verified')">
                    âœ“ Verified
                </button>
                <button class="verify-btn incorrect" onclick="verifyClaim(${claim.id}, 'invalid')">
                    âœ— Invalid
                </button>
                <button class="btn" onclick="showVerificationSuggestions(${claim.id})">
                    How to Verify?
                </button>
            </div>
        </div>
    `;
}

async function verifyClaim(claimId, result) {
    await fetch(`/api/claims/${claimId}/verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            verification_result: result,
            verification_method: 'manual_check'
        })
    });

    // Reload claims
    const planId = getCurrentPlanId(); // Implement this based on your UI state
    loadPlanClaims(planId);
}

async function showVerificationSuggestions(claimId) {
    const response = await fetch(`/api/claims/${claimId}/verification-suggestions`);
    const data = await response.json();

    const container = document.getElementById('verificationSuggestions');
    container.innerHTML = data.suggestions.map(sug => `
        <div class="suggestion-item">
            <h4>${sug.method}</h4>
            <p>${sug.description}</p>
            <p style="color: #888; font-size: 0.9em;">Est. time: ${sug.estimated_time}</p>
        </div>
    `).join('');

    document.getElementById('verificationModal').classList.add('active');
}

function closeVerificationModal() {
    document.getElementById('verificationModal').classList.remove('active');
}

function jumpToSource(artifactId) {
    // TODO: Implement scrolling to artifact or opening artifact viewer
    console.log('Jump to artifact', artifactId);
}

// ============ CALENDAR & DEADLINES ============

async function loadCalendar() {
    const response = await fetch('/api/deadlines?upcoming_only=true');
    const deadlines = await response.json();

    const container = document.getElementById('timelineView');
    container.innerHTML = deadlines.map(deadline => `
        <div class="timeline-item">
            <div class="timeline-date">
                ${new Date(deadline.due_date).toLocaleDateString()}
            </div>
            <div class="timeline-content">
                <span class="deadline-type type-${deadline.deadline_type}">
                    ${deadline.deadline_type}
                </span>
                <strong>${deadline.title}</strong>
                <div style="font-size: 0.9em; color: #888; margin-top: 5px;">
                    Confidence: ${deadline.extraction_confidence}
                </div>
            </div>
        </div>
    `).join('');
}

async function exportCalendar() {
    window.open('/api/calendar/export', '_blank');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    initInbox();
    // Call these when navigating to respective sections
    // loadCalendar();
});
</script>
